<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Live Ride - GreenRide</title>
    <meta charset="UTF-8">
    <style>
        :root { --bg-color: #0a0a0a; --card-bg: #18181b; --text-color: #ededed; --accent-color: #4ade80; --danger-color: #ef4444; }

        body {
            font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0;
            display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column;
            text-align: center; overflow: hidden; position: relative;
        }

        /* --- 1. RADAR EFFECT (Small & Smooth) --- */
        .radar-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0; display: flex; align-items: center; justify-content: center; }

        .car-icon { width: 15px; height: 15px; background: var(--accent-color); border-radius: 50%; z-index: 10; box-shadow: 0 0 15px var(--accent-color), 0 0 30px var(--accent-color); }

        .radar-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 1px solid var(--accent-color); border-radius: 50%; opacity: 0; z-index: 1;
            box-shadow: 0 0 10px var(--accent-color); animation: radarPulse 8s linear infinite;
        }
        .radar-ring:nth-child(1) { animation-delay: 0s; }
        .radar-ring:nth-child(2) { animation-delay: 2s; }
        .radar-ring:nth-child(3) { animation-delay: 4s; }
        .radar-ring:nth-child(4) { animation-delay: 6s; }

        @keyframes radarPulse {
            0% { width: 0; height: 0; opacity: 0.0; border-width: 2px; }
            5% { opacity: 0.5; }
            100% { width: 35vmin; height: 35vmin; opacity: 0; border-width: 0px; }
        }

        /* --- 2. LAYOUT --- */
        .content-layer { position: relative; z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center; }

        .info-container {
            width: 100%; max-width: 500px; text-align: center;
            background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 70%);
            padding: 40px; border-radius: 50%;
        }

        h1 { font-size: 3rem; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .sub-text { color: #aaa; margin-bottom: 30px; font-size: 1.1rem; background: rgba(30,30,30,0.6); border: 1px solid #333; padding: 5px 15px; border-radius: 20px; display: inline-block; }

        .progress-wrapper { width: 100%; background: rgba(255,255,255,0.1); height: 6px; border-radius: 4px; overflow: hidden; margin-bottom: 40px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.2s linear; box-shadow: 0 0 15px var(--accent-color); }

        .time-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 20px; width: 100%; }
        .time-box h3 { margin: 0; font-size: 2.5rem; font-weight: 300; }
        .time-box span { color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }

        /* BUTTONS (Fixed Overlap) */
        .btn-finish { background: var(--danger-color); color: white; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 50px; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); transition: transform 0.2s; }
        .btn-finish:hover { transform: scale(1.05); }

        /* Changed from absolute to relative margin to prevent overlap */
        .btn-back { margin-top: 40px; color: #666; text-decoration: none; border: 1px solid #333; padding: 8px 20px; border-radius: 20px; transition: 0.3s; background: rgba(0,0,0,0.5); display: inline-block; }
        .btn-back:hover { border-color: #fff; color: #fff; }

        /* RATING SCREEN */
        #ratingScreen { display: none; flex-direction: column; align-items: center; width: 100%; z-index: 50; position: relative;}
        .participant-card { background: #222; padding: 15px; border-radius: 12px; border: 1px solid #444; text-align: left; margin-bottom: 15px; width: 100%; box-sizing: border-box; }

        /* THANK YOU SCREEN */
        #thankYouScreen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; animation: fadeIn 1s; }
    </style>
</head>
<body>

<div class="radar-center">
    <div class="radar-ring"></div>
    <div class="radar-ring"></div>
    <div class="radar-ring"></div>
    <div class="radar-ring"></div>
    <div class="car-icon"></div>
</div>

<div id="liveScreen" class="content-layer">
    <div class="info-container">
        <h1 id="statusText">En Route</h1>
        <p class="sub-text">Heading to <strong style="color:white;" th:text="${route.destinationAddress}">Dest</strong></p>
        <div class="progress-wrapper"><div class="progress-fill" id="pBar"></div></div>
        <div class="time-grid">
            <div class="time-box"><h3 id="clock">00:00</h3><span>Current Time</span></div>
            <div class="time-box"><h3 id="arrivalTimeDisplay">--:--</h3><span>Estimated Arrival</span></div>
        </div>
    </div>

    <div th:if="${#authentication.name == route.driver.username}">
        <form th:action="@{/ride/{id}/finish(id=${route.id})}" method="post">
            <button type="submit" class="btn-finish">üèÅ FINISH RIDE</button>
        </form>
    </div>

    <a href="/" class="btn-back">Minimize</a>
</div>

<div id="ratingScreen" class="content-layer" style="display: none;">

    <div th:if="${!allRated}" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
        <h1>Ride Finished</h1>
        <p class="sub-text">Please rate your fellow travelers:</p>

        <div style="width: 100%; max-width: 500px; overflow-y: auto; max-height: 60vh; padding: 0 10px;">
            <div th:each="person : ${participants}" class="participant-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: white; font-size: 1.1rem;" th:text="${person.fullName}">Name</strong>
                    <span style="font-size: 0.8rem; color: #888; text-transform: uppercase;">
                            <span th:if="${person.username == route.driver.username}">DRIVER</span>
                            <span th:if="${person.username != route.driver.username}">PASSENGER</span>
                        </span>
                </div>
                <form th:action="@{/ride/{id}/rate(id=${route.id})}" method="post">
                    <input type="hidden" name="targetUsername" th:value="${person.username}">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <label style="cursor: pointer;"><input type="radio" name="rating" value="5" required> 5‚òÖ</label>
                        <label style="cursor: pointer;"><input type="radio" name="rating" value="4"> 4‚òÖ</label>
                        <label style="cursor: pointer;"><input type="radio" name="rating" value="3"> 3‚òÖ</label>
                        <label style="cursor: pointer;"><input type="radio" name="rating" value="2"> 2‚òÖ</label>
                        <label style="cursor: pointer;"><input type="radio" name="rating" value="1"> 1‚òÖ</label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="comment" placeholder="Comment..." style="flex: 1; padding: 8px; border-radius: 5px; border: none;">
                        <button type="submit" class="btn-finish" style="margin: 0; padding: 8px 15px; font-size: 0.9rem; background: var(--accent-color);">Rate</button>
                    </div>
                </form>
            </div>
            <a href="/" class="btn-back">Return to Dashboard</a>
        </div>
    </div>

    <div th:if="${allRated}" id="thankYouScreen" style="display: flex;">
        <div style="font-size: 5rem; margin-bottom: 20px;">üéâ</div>
        <h1>All Done!</h1>
        <p class="sub-text">Thank you for your feedback.</p>
        <a href="/" class="btn-finish" style="background: var(--accent-color); text-decoration: none; margin-top: 20px;">Return Home</a>
    </div>

</div>

<input type="hidden" id="departureStr" th:value="${route.departureTime}">
<input type="hidden" id="durationSec" th:value="${route.estimatedDurationSeconds}">
<input type="hidden" id="routeId" th:value="${route.id}">
<input type="hidden" id="initialStatus" th:value="${route.status.name()}">

<script>
    const departureStr = document.getElementById('departureStr').value;
    const durationSec = parseInt(document.getElementById('durationSec').value);
    const routeId = document.getElementById('routeId').value;
    const initialStatus = document.getElementById('initialStatus').value;

    // --- 1. SWITCH LOGIC ---
    function showRatingScreen() {
        document.getElementById('liveScreen').style.display = 'none';
        document.querySelector('.radar-center').style.display = 'none';
        document.getElementById('ratingScreen').style.display = 'flex';
    }

    if (initialStatus === 'COMPLETED') {
        showRatingScreen();
    } else {
        setInterval(() => {
            fetch(`/api/ride/${routeId}/status`)
                .then(res => res.json())
                .then(data => { if (data.status === 'COMPLETED') showRatingScreen(); });
        }, 3000);
    }

    // --- 2. PROGRESS LOGIC ---
    const startTime = new Date(departureStr);
    const endTime = new Date(startTime.getTime() + durationSec * 1000);
    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
    document.getElementById('arrivalTimeDisplay').innerText = endTime.toLocaleTimeString('en-GB', timeOptions);

    function updateProgress() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB', timeOptions);
        let percent = 0;
        if (now > startTime) {
            const elapsed = (now - startTime) / 1000;
            percent = (elapsed / durationSec) * 100;
        }
        if (percent > 100) percent = 100;
        if (percent < 0) percent = 0;
        document.getElementById('pBar').style.width = percent + '%';
    }
    setInterval(updateProgress, 1000);
    updateProgress();
</script>
</body>
</html>